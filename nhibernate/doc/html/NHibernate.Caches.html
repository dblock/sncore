<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Chapter 8. NHibernate.Caches</title><link rel="stylesheet" href="html.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.69.1"><link rel="start" href="index.html" title="NHibernate Documentation 1.0.1.0"><link rel="up" href="NHibernateContrib.html" title="Part II. NHibernateContrib Documentation"><link rel="prev" href="NHibernateContrib.Preface.html" title="Preface"><link rel="next" href="NHibernate.Mapping.Attributes.html" title="Chapter 9. NHibernate.Mapping.Attributes"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 8. NHibernate.Caches</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="NHibernateContrib.Preface.html">Prev</a> </td><th width="60%" align="center">Part II. NHibernateContrib Documentation</th><td width="20%" align="right"> <a accesskey="n" href="NHibernate.Mapping.Attributes.html">Next</a></td></tr></table><hr></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="NHibernate.Caches"></a>Chapter 8. NHibernate.Caches</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="NHibernate.Caches.html#NHibernate.Caches-howto">How to use them?</a></span></dt><dt><span class="section"><a href="NHibernate.Caches.html#NHibernate.Caches.Prevalence">Prevalence Cache Configuration</a></span></dt><dt><span class="section"><a href="NHibernate.Caches.html#NHibernate.Caches.SysCache">SysCache Configuration</a></span></dt></dl></div><div class="abstract"><a name="NHibernate.Caches-abstract"></a><p class="title"><b>What is NHibernate.Caches?</b></p><p><b>NHibernate.Caches are add-ins for <a href="http://www.nhibernate.org" target="_blank">NHibernate</a> contributed by Kevin Williams (aka <span class="emphasis"><em>k-dub</em></span>). </b>A cache is place where entities are kept (at their first loading); once in cache, they can be retrieved without having to query them (again) in the back-end storage. This means that they are faster to (re)load.</p><p>An NHibernate session has an internal (first-level) cache where it keeps its entities. There is no share between these caches; so a session is destroyed with its cache. NHibernate provides a <span class="emphasis"><em>second-level cache</em></span> system; it works at the SessionFactory level. So it is shared by all sessions created by the same SessionFactory.</p><p>An important point is that the second-level cache <span class="strong"><strong>does not</strong></span> cache instances of the object type being cached; instead it caches the individual values of the properties of that object. This provides two benefits. One, NHibernate doesn't have to worry that your client code will manipulate the objects in a way that will disrupt the cache. Two, the relationships and associations do not become stale, and are easy to keep up-to-date because they are simply identifiers. The cache is not a tree of objects but rather a map of arrays.</p><p>With the <span class="emphasis"><em>session-per-request</em></span> model, a high number of Session can concurrently access to the same entity without hitting the database each time; hence the performance gain.</p><p>These contributions make it possible to use different cache providers for NHibernate:
			</p><div class="itemizedlist"><ul type="disc"><li><p>
						<span class="strong"><strong>NHibernate.Caches.Prevalence</strong></span> makes it possible to use the underlying <code class="classname">Bamboo.Prevalence</code> implementation as cache provider. Open the file <code class="filename">Bamboo.Prevalence.license.txt</code> for more information about its license; you can also visit its <a href="http://bbooprevalence.sourceforge.net/" target="_blank">website</a>.</p></li><li><p>
						<span class="strong"><strong>NHibernate.Caches.SysCache</strong></span> makes it possible to use the underlying <code class="classname">System.Web.Caching.Cache</code> implementation as cache provider. This means that you can rely on ASP.NET caching feature to understand how it works. For more information, read (on the MSDN): <a href="http://msdn.microsoft.com/library/en-us/cpguide/html/cpconcacheapis.asp" target="_blank">Caching Application Data</a>.</p></li></ul></div><p>
		</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="NHibernate.Caches-howto"></a>How to use them?</h2></div></div></div><p>Here are the steps to follow to enable the second-level cache in NHibernate:</p><p>
			</p><div class="itemizedlist"><ul type="disc"><li><p>Choose the cache provider you want to use and copy its assembly in your assemblies directory (<code class="filename">NHibernate.Caches.Prevalence.dll</code> or <code class="filename">NHibernate.Caches.SysCache.dll</code>).</p></li><li><p>To tells which cache provider to use, add in your NHibernate configuration file (can be <code class="filename">YourAssembly.exe.config</code> or <code class="filename">web.config</code> or a <code class="filename">.cfg.xml</code> file):
					</p><pre class="programlisting">
&lt;add key="hibernate.cache.provider_class" value="<code class="literal">XXX</code>" /&gt;<a name="hibernate.cache.provider_class-co" href="NHibernate.Caches.html#hibernate.cache.provider_class">(1)</a>
&lt;add key="relativeExpiration" value="<code class="literal">120</code>" /&gt;<a name="nhcaches-relativeExpiration-co" href="NHibernate.Caches.html#nhcaches-relativeExpiration">(2)</a>
						</pre><p>
						</p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><a name="hibernate.cache.provider_class"></a><a href="#hibernate.cache.provider_class-co">(1)</a> </td><td valign="top" align="left"><p>"<code class="literal">XXX</code>" can either be "<code class="classname">NHibernate.Caches.Prevalence.PrevalenceCacheProvider, NHibernate.Caches.Prevalence</code>" or "<code class="classname">NHibernate.Caches.SysCache.SysCacheProvider, NHibernate.Caches.SysCache</code>".</p></td></tr><tr><td width="5%" valign="top" align="left"><a name="nhcaches-relativeExpiration"></a><a href="#nhcaches-relativeExpiration-co">(2)</a> </td><td valign="top" align="left"><p>The <code class="literal">relativeExpiration</code> value is the number of seconds you wish to cache each entry (here two minutes). This example applies to SysCache only.</p></td></tr></table></div><p>
					</p></li><li><p>Add <span class="strong"><strong>&lt;cache usage="read-write|nonstrict-read-write|read-only"/&gt;</strong></span> (just after <span class="emphasis"><em>&lt;class&gt;</em></span>) in the mapping of the entities you want to cache. It also works for collections (bag, list, map, set, ...).</p></li></ul></div><p>
		</p><p><b>Be careful. </b>Caches are never aware of changes made to the persistent store by another process (though they may be configured to regularly expire cached data). As the caches are created at the SessionFactory level, they are destroyed with the SessionFactory instance; so you must keep it alive as long as you need them.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="NHibernate.Caches.Prevalence"></a>Prevalence Cache Configuration</h2></div></div></div><p>There is only one configurable parameter: prevalenceBase. This is the directory on the file system where the Prevalence engine will save data. It can be relative to the current directory or a full path. If the directory doesn't exist, it will be created.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="NHibernate.Caches.SysCache"></a>SysCache Configuration</h2></div></div></div><p>As the SysCache relies on <code class="classname">System.Web.Caching.Cache</code> for the underlying implementation, the configuration is based on the available options that make sense for NHibernate to utilize.</p><p>
			</p><div class="itemizedlist"><ul type="disc"><li><p>staticExpiration = a specific DateTime to expire each item on</p></li><li><p>relativeExpiration = number of seconds to wait before expiring each item</p></li><li><p>priority = a numeric cost of expiring each item, where 1 is a low cost, 5 is the highest, and 3 is normal. Only values 1 through 5 are valid.</p></li></ul></div><p>
		</p><p>SysCache has a config file section handler to allow configuring different expirations and priorities for different regions. Here's an example:</p><pre class="programlisting">
&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;configuration&gt;
	&lt;configSections&gt;
		&lt;section name="syscache" type="NHibernate.Caches.SysCache.SysCacheSectionHandler,NHibernate.Caches.SysCache" /&gt;
		&lt;section name="nhibernate" type="System.Configuration.NameValueSectionHandler, System, Version=1.0.5000.0,Culture=neutral, PublicKeyToken=b77a5c561934e089" /&gt;
		&lt;section name="log4net" type="log4net.Config.Log4NetConfigurationSectionHandler,log4net" /&gt;
	&lt;/configSections&gt;

	&lt;syscache&gt;
		&lt;cache region="foo" relativeExpiration="500" priority="4" /&gt;
		&lt;cache region="bar" staticExpiration="2100-12-31" /&gt;
	&lt;/syscache&gt;
	&lt;nhibernate&gt;
		&lt;add key="hibernate.connection.provider" value="NHibernate.Connection.DriverConnectionProvider" /&gt;
		&lt;add key="hibernate.connection.isolation" value="ReadCommitted" /&gt;
		&lt;add key="hibernate.dialect" value="NHibernate.Dialect.MsSql2000Dialect" /&gt;
		&lt;add key="hibernate.connection.driver_class" value="NHibernate.Driver.SqlClientDriver" /&gt;
		&lt;add key="hibernate.connection.connection_string"  value="Server=localhost;initial catalog=nhibernate;Integrated Security=SSPI" /&gt;
		&lt;add key="hibernate.cache.provider_class" value="NHibernate.Caches.SysCache.SysCacheProvider,NHibernate.Caches.SysCache" /&gt;
	&lt;/nhibernate&gt;
	&lt;log4net debug="true"&gt;&lt;appender name="rollingFile" type="log4net.Appender.RollingFileAppender,log4net" &gt;
			&lt;param name="File" value="log.txt" /&gt;
			&lt;param name="AppendToFile" value="true" /&gt;
			&lt;param name="RollingStyle" value="Date" /&gt;
			&lt;param name="DatePattern" value="yyyy.MM.dd" /&gt;
			&lt;param name="StaticLogFileName" value="true" /&gt;
			&lt;layout type="log4net.Layout.PatternLayout,log4net"&gt;
				&lt;param name="ConversionPattern" value="%d [%t] %-5p %c [%x] &amp;lt;%X{auth}&amp;gt; - %m%n" /&gt;
			&lt;/layout&gt;
		&lt;/appender&gt;
		&lt;root&gt;
			&lt;priority value="ALL" /&gt;
			&lt;appender-ref ref="rollingFile" /&gt;
		&lt;/root&gt;
	&lt;/log4net&gt;
&lt;/configuration&gt;
		</pre></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="NHibernateContrib.Preface.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="NHibernateContrib.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="NHibernate.Mapping.Attributes.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Preface </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 9. NHibernate.Mapping.Attributes</td></tr></table></div></body></html>
